<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Alipay on dongri</title>
    <link>https://dongri.github.io/tags/alipay/</link>
    <description>Recent content in Alipay on dongri</description>
    <generator>Hugo</generator>
    <language>en-us</language>
    <lastBuildDate>Sat, 08 Dec 2018 10:55:01 +0900</lastBuildDate>
    <atom:link href="https://dongri.github.io/tags/alipay/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>WeChat Pay, Alipay両方対応QRコード</title>
      <link>https://dongri.github.io/2018/12/wechat-pay-alipay%E4%B8%A1%E6%96%B9%E5%AF%BE%E5%BF%9Cqr%E3%82%B3%E3%83%BC%E3%83%89/</link>
      <pubDate>Sat, 08 Dec 2018 10:55:01 +0900</pubDate>
      <guid>https://dongri.github.io/2018/12/wechat-pay-alipay%E4%B8%A1%E6%96%B9%E5%AF%BE%E5%BF%9Cqr%E3%82%B3%E3%83%BC%E3%83%89/</guid>
      <description>&lt;p&gt;先週会社のオフサイトで中国上海に行って来ました。&lt;/p&gt;&#xA;&lt;p&gt;&amp;ldquo;QRコード決済先進国、中国・上海にて、どのようにQRコード決済が人々の生活の一部になっているのかを実際に「見る」、「体験する」ことが醍醐味です。&amp;rdquo; らしいです。&lt;/p&gt;&#xA;&lt;p&gt;QRコードで決済する以外にもofo,mobike QRコードで鍵を解除できたら、QRコードで自販機のジュース買えたりなどなど。&lt;/p&gt;&#xA;&lt;p&gt;そこでみんなが気になってたのが、店頭に置いてある一枚のQRコードでWeChat Pay, Alipayどっちも決済できることでした。どのアプリからスキャンしても正しく認識して決済画面に遷移させるQRコードのことです。その辺の仕組み調べたので共有しようと思います。&lt;/p&gt;&#xA;&lt;h2 id=&#34;アプリの判別&#34;&gt;アプリの判別&lt;/h2&gt;&#xA;&lt;p&gt;WeChatからスキャンされたか、AlipayからスキャンされたかはUser Agentで判別します。&#xA;下の図がAlipayとWeChatからスキャンされたときのUser Agentです。&lt;/p&gt;&#xA;&lt;!-- raw HTML omitted --&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;if (navigator.userAgent.match(/Alipay/i)) {&#xA;  // Alipay&#xA;} else if (navigator.userAgent.match(/MicroMessenger\//i)) {&#xA;  // WeChat pay&#xA;} else {&#xA;  // その他&#xA;}&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Javascriptの例ですが、これをnginxのレベルで判別してもいいし、アプリケーションサーバー側で判別してもいいかと思います。&lt;/p&gt;&#xA;&lt;h2 id=&#34;alipay&#34;&gt;Alipay&lt;/h2&gt;&#xA;&lt;p&gt;AlipayのQRコードはURL形式になっていて、アプリ判別したら用意したURLにリダイレクトすれば決済（送金）画面に遷移します。&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;例: https://qr.alipay.com/fkx07120vzhsliuln927l74&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;wechat-pay&#34;&gt;WeChat Pay&lt;/h2&gt;&#xA;&lt;p&gt;WeChat PayはカスタマURLスキーム形式になっていて、Alipayのようにリダイレクトさせてもアプリが認識してくれませんでした。&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;例: wxp://f2f067yve_yNrmWOKjAmyEeuYcStPZXhjpud&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;スマートな方法ではないですが、WeChat Payのオリジナル「お金を受け取るQRコード」を表示させて、ユーザーがそれを長押しして「画像内のQRコードをスキャンする」でアプリに認識させる方法があります。&lt;/p&gt;&#xA;&lt;!-- raw HTML omitted --&gt;&#xA;&lt;h2 id=&#34;実装&#34;&gt;実装&lt;/h2&gt;&#xA;&lt;p&gt;簡単な例ですが、こんな感じになります。ここの &lt;code&gt;weixin.png&lt;/code&gt; を自分のオリジナルQRコードの画像に置き換えてください。&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;&amp;lt;div id=&amp;#34;weixin&amp;#34; style=&amp;#34;display: none;&amp;#34;&amp;gt;&#xA;  &amp;lt;img src=&amp;#34;./weixin.png&amp;#34; style=&amp;#34;width: 300px;&amp;#34;&amp;gt;&#xA;  &amp;lt;br&amp;gt;&#xA;  &amp;lt;h4&amp;gt;QRコードを長押しして認識させる&amp;lt;/h4&amp;gt;&#xA;&amp;lt;/div&amp;gt;&#xA;&amp;lt;script&amp;gt;&#xA;  if (navigator.userAgent.match(/Alipay/i)) {&#xA;    window.location.href = &amp;#34;https://qr.alipay.com/fkx07120vzhsliuln927l74&amp;#34;;&#xA;  } else if (navigator.userAgent.match(/MicroMessenger\//i)) {&#xA;    document.getElementById(&amp;#34;weixin&amp;#34;).style.display = &amp;#39;block&amp;#39;;&#xA;  } else {&#xA;    alert(&amp;#34;Only Support WeChat Pay and Alipay&amp;#34;);&#xA;  }&#xA;&amp;lt;/script&amp;gt;&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;!-- raw HTML omitted --&gt;&lt;!-- raw HTML omitted --&gt;&#xA;このQRコードをWeChatとAlipayどれからスキャンしても相手に送金する画面に遷移します。（間違って送金しないように）&lt;/p&gt;</description>
    </item>
  </channel>
</rss>
